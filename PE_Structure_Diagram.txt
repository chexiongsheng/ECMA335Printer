┌─────────────────────────────────────────────────────────────────────────┐
│                          .NET PE File Structure                         │
│                     (ECMA-335 Assembly Format)                          │
└─────────────────────────────────────────────────────────────────────────┘

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
┌───────────────────────────────────────────────────────────────┐
│                      DOS Header (64 bytes)                    │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ Signature 'MZ' (0x5A4D)     │  ...other fields...       │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │              PE Header Offset @ 0x3C (4 bytes)          │  │
│  └─────────────────────────────────────────────────────────┘  │
├───────────────────────────────────────────────────────────────┤
│                   DOS Stub (Variable size)                    │
│                    (Legacy DOS program)                       │
├───────────────────────────────────────────────────────────────┤
│              PE Signature 'PE\0\0' (4 bytes)                  │
│                      (0x00004550)                             │
├───────────────────────────────────────────────────────────────┤
│                    COFF Header (20 bytes)                     │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ Machine (2)    │ NumberOfSections (2)                   │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │                  TimeDateStamp (4 bytes)                │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │              PointerToSymbolTable (4 bytes)             │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │                NumberOfSymbols (4 bytes)                │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │ SizeOfOptionalHeader (2) │ Characteristics (2)          │  │
│  └─────────────────────────────────────────────────────────┘  │
├───────────────────────────────────────────────────────────────┤
│    ╔═══════════════════════════════════════════════════════╗  │
│    ║   Optional Header (224 bytes PE32 / 240 bytes PE32+)  ║  │
│    ╚═══════════════════════════════════════════════════════╝  │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ P 1: Standard Fields (96 bytes PE32 / 112 bytes PE32+)  |  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │ Magic (2)      │ Linker Version (2)                     │  │
│  │  0x10B=PE32 / 0x20B=PE32+                               │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │                   SizeOfCode (4 bytes)                  │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │              SizeOfInitializedData (4 bytes)            │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │            SizeOfUninitializedData (4 bytes)            │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │               AddressOfEntryPoint (4 bytes)             │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │                  BaseOfCode (4 bytes)                   │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │            ImageBase (4 bytes PE32 / 8 bytes PE32+)     │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │  SectionAlignment (4)  │  FileAlignment (4)             │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │  OS Version (4)        │  Image Version (4)             │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │  Subsystem Version (4) │  Win32VersionValue (4)         │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │                  SizeOfImage (4 bytes)                  │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │                 SizeOfHeaders (4 bytes)                 │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │                   CheckSum (4 bytes)                    │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │  Subsystem (2)     │  DllCharacteristics (2)            │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │         SizeOfStackReserve (4/8 bytes)                  │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │          SizeOfStackCommit (4/8 bytes)                  │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │          SizeOfHeapReserve (4/8 bytes)                  │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │           SizeOfHeapCommit (4/8 bytes)                  │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │  LoaderFlags (4)       │  NumberOfRvaAndSizes (4)       │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │ P 2: Data Directories (128 bytes = 16 entries × 8)      │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │ Entry 0:  Export Table         RVA (4) │ Size (4)       │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │ Entry 1:  Import Table         RVA (4) │ Size (4)       │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │ Entry 2:  Resource Table       RVA (4) │ Size (4)       │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │ Entry 3:  Exception Table      RVA (4) │ Size (4)       │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │ Entry 4:  Certificate Table    RVA (4) │ Size (4)       │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │ Entry 5:  Base Relocation      RVA (4) │ Size (4)       │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │ Entry 6:  Debug                RVA (4) │ Size (4)       │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │ Entry 7:  Architecture         RVA (4) │ Size (4)       │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │ Entry 8:  Global Ptr           RVA (4) │ Size (4)       │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │ Entry 9:  TLS Table            RVA (4) │ Size (4)       │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │ Entry 10: Load Config Table    RVA (4) │ Size (4)       │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │ Entry 11: Bound Import         RVA (4) │ Size (4)       │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │ Entry 12: IAT                  RVA (4) │ Size (4)       │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │ Entry 13: Delay Import Desc    RVA (4) │ Size (4)       │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │ Entry 14: CLI Header (.NET)    RVA (4) │ Size (4)  ◄──  │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │ Entry 15: Reserved             RVA (4) │ Size (4)       │  │
│  └─────────────────────────────────────────────────────────┘  │
│    ╚═══════════════════════════════════════════════════════╝  │
│         (End of Optional Header - Total 224/240 bytes)        │
├───────────────────────────────────────────────────────────────┤
│         Section Headers (40 bytes × N sections)               │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                    Name (8 bytes)                       │  │
│  │              (e.g., ".text", ".rsrc")                   │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │  VirtualSize (4)       │  VirtualAddress (4)            │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │  SizeOfRawData (4)     │  PointerToRawData (4)          │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │  PointerToRelocations (4) │ PointerToLinenumbers (4)    │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │ NumOfRelocations (2) │ NumOfLinenumbers (2)             │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │                 Characteristics (4 bytes)               │  │
│  └─────────────────────────────────────────────────────────┘  │
│                    ... repeat for each section ...            │
├───────────────────────────────────────────────────────────────┤
│                    Section Data (.text)                       │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                  CLI Header (72 bytes)                  │  │
│  │  ┌───────────────────────────────────────────────────┐  │  │
│  │  │                    Cb (4 bytes)                   │  │  │
│  │  │              (Size of this header)                │  │  │
│  │  ├───────────────────────────────────────────────────┤  │  │
│  │  │ MajorRuntimeVer (2) │ MinorRuntimeVer (2)         │  │  │
│  │  ├───────────────────────────────────────────────────┤  │  │
│  │  │  MetadataRVA (4)    │  MetadataSize (4)           │  │  │
│  │  ├───────────────────────────────────────────────────┤  │  │
│  │  │  Flags (4)          │  EntryPointToken (4)        │  │  │
│  │  │  (ILOnly, 32Bit,    │  (Method token or RVA)      │  │  │
│  │  │   StrongNameSigned) │                             │  │  │
│  │  ├───────────────────────────────────────────────────┤  │  │
│  │  │  ResourcesRVA (4)   │  ResourcesSize (4)          │  │  │
│  │  ├───────────────────────────────────────────────────┤  │  │
│  │  │ StrongNameSigRVA(4) │ StrongNameSigSize (4)       │  │  │
│  │  ├───────────────────────────────────────────────────┤  │  │
│  │  │  CodeManagerTable (4) │ CodeManagerTableSize (4)  │  │  │
│  │  ├───────────────────────────────────────────────────┤  │  │
│  │  │  VTableFixupsRVA (4)  │ VTableFixupsSize (4)      │  │  │
│  │  ├───────────────────────────────────────────────────┤  │  │
│  │  │  ExportAddressTableJumps (4) │ Reserved (4)       │  │  │
│  │  ├───────────────────────────────────────────────────┤  │  │
│  │  │  ManagedNativeHeaderRVA (4) │ ManagedNativeSize   │  │  │
│  │  └───────────────────────────────────────────────────┘  │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │                 Metadata Root (Variable)                │  │
│  │  ┌───────────────────────────────────────────────────┐  │  │
│  │  │         Signature 'BSJB' (0x424A5342)             │  │  │
│  │  ├───────────────────────────────────────────────────┤  │  │
│  │  │ MajorVersion (2)    │ MinorVersion (2)            │  │  │
│  │  ├───────────────────────────────────────────────────┤  │  │
│  │  │                  Reserved (4 bytes)               │  │  │
│  │  ├───────────────────────────────────────────────────┤  │  │
│  │  │               VersionLength (4 bytes)             │  │  │
│  │  ├───────────────────────────────────────────────────┤  │  │
│  │  │          Version String (variable, aligned)       │  │  │
│  │  │     (e.g., "v4.0.30319" padded to 4-byte align)   │  │  │
│  │  ├───────────────────────────────────────────────────┤  │  │
│  │  │ Flags (2)           │ NumberOfStreams (2)         │  │  │
│  │  └───────────────────────────────────────────────────┘  │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │              Stream Headers (Variable size)             │  │
│  │  For each stream (typically 5 streams):                 │  │
│  │  ┌───────────────────────────────────────────────────┐  │  │
│  │  │  Offset (4)         │  Size (4)                   │  │  │
│  │  ├───────────────────────────────────────────────────┤  │  │
│  │  │          Name (null-terminated, aligned)          │  │  │
│  │  │     (e.g., "#~", "#Strings", "#US", "#GUID",      │  │  │
│  │  │            "#Blob")                               │  │  │
│  │  └───────────────────────────────────────────────────┘  │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │              Metadata Streams (Variable size)           │  │
│  │  ┌───────────────────────────────────────────────────┐  │  │
│  │  │ Stream #~ or #- : Metadata Tables (compressed)    │  │  │
│  │  │  ┌─────────────────────────────────────────────┐  │  │  │
│  │  │  │ Reserved (4) │ MajorVersion (1) │ Minor (1) │  │  │  │
│  │  │  ├─────────────────────────────────────────────┤  │  │  │
│  │  │  │ HeapSizes (1) │ Reserved (1) │ Valid (8)    │  │  │  │
│  │  │  ├─────────────────────────────────────────────┤  │  │  │
│  │  │  │              Sorted (8 bytes)               │  │  │  │
│  │  │  ├─────────────────────────────────────────────┤  │  │  │
│  │  │  │         Row counts for each table           │  │  │  │
│  │  │  │  (4 bytes per table, only for valid tables) │  │  │  │
│  │  │  ├─────────────────────────────────────────────┤  │  │  │
│  │  │  │              Table data rows                │  │  │  │
│  │  │  │  Tables: Module, TypeRef, TypeDef, Field,   │  │  │  │
│  │  │  │  MethodDef, Param, InterfaceImpl, MemberRef,│  │  │  │
│  │  │  │  Constant, CustomAttribute, FieldMarshal,   │  │  │  │
│  │  │  │  DeclSecurity, ClassLayout, FieldLayout,    │  │  │  │
│  │  │  │  StandAloneSig, EventMap, Event, PropertyMap│  │  │  │
│  │  │  │  Property, MethodSemantics, MethodImpl,     │  │  │  │
│  │  │  │  ModuleRef, TypeSpec, ImplMap, FieldRVA,    │  │  │  │
│  │  │  │  Assembly, AssemblyProcessor, AssemblyOS,   │  │  │  │
│  │  │  │  AssemblyRef, AssemblyRefProcessor,         │  │  │  │
│  │  │  │  AssemblyRefOS, File, ExportedType,         │  │  │  │
│  │  │  │  ManifestResource, NestedClass,             │  │  │  │
│  │  │  │  GenericParam, MethodSpec, GenericParamCons │  │  │  │
│  │  │  └─────────────────────────────────────────────┘  │  │  │
│  │  ├───────────────────────────────────────────────────┤  │  │
│  │  │ Stream #Strings : String heap                     │  │  │
│  │  │   Null-terminated UTF-8 strings indexed by offset │  │  │
│  │  ├───────────────────────────────────────────────────┤  │  │
│  │  │ Stream #US : User string heap                     │  │  │
│  │  │   Length-prefixed UTF-16 strings (for ldstr)      │  │  │
│  │  ├───────────────────────────────────────────────────┤  │  │
│  │  │ Stream #GUID : GUID heap                          │  │  │
│  │  │   Array of 16-byte GUIDs indexed by 1-based index │  │  │
│  │  ├───────────────────────────────────────────────────┤  │  │
│  │  │ Stream #Blob : Binary large object heap           │  │  │
│  │  │   Length-prefixed binary data (signatures, etc.)  │  │  │
│  │  └───────────────────────────────────────────────────┘  │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │                    IL Code (Variable)                   │  │
│  │   Method bodies with IL instructions and exception      │  │
│  │   handling clauses                                      │  │
│  └─────────────────────────────────────────────────────────┘  │
├───────────────────────────────────────────────────────────────┤
│              Other Sections (.rsrc, .reloc, etc.)             │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ .rsrc : Resources (images, strings, etc.)               │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │ .reloc : Base relocations for address fixups            │  │
│  └─────────────────────────────────────────────────────────┘  │
└───────────────────────────────────────────────────────────────┘

Legend:
  RVA = Relative Virtual Address (offset from image base in memory)
  (N) = Size in bytes
  ◄── = Important for .NET assemblies
  
Notes:
  • All multi-byte values are stored in little-endian format
  • Strings in metadata are UTF-8 encoded (except #US which is UTF-16)
  • Table indices can be 2 or 4 bytes depending on row counts (HeapSizes flag)
  • The CLI Header (Entry 14) is what makes this a .NET assembly
  • Metadata tables use compressed tokens for space efficiency
